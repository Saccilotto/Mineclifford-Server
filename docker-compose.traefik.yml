version: '3.8'

services:
  # Traefik Reverse Proxy with Let's Encrypt + Cloudflare DNS
  traefik:
    image: traefik:v2.10
    container_name: mineclifford-traefik
    restart: unless-stopped
    command:
      # API and dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"

      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=mineclifford-network"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      # Let's Encrypt with Cloudflare DNS Challenge
      - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53"
      - "--certificatesresolvers.cloudflare.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json"
      # Uncomment for testing (uses staging server)
      # - "--certificatesresolvers.cloudflare.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

      # Security headers
      - "--entrypoints.websecure.http.tls=true"
      - "--entrypoints.websecure.http.tls.certResolver=cloudflare"
      - "--entrypoints.websecure.http.tls.domains[0].main=${DOMAIN_NAME}"
      - "--entrypoints.websecure.http.tls.domains[0].sans=*.${DOMAIN_NAME}"

    ports:
      - "80:80"
      - "443:443"

    environment:
      # Cloudflare API credentials for DNS challenge
      - CF_API_EMAIL=${CF_API_EMAIL:-}
      - CF_DNS_API_TOKEN=${CF_API_TOKEN}
      - CF_ZONE_API_TOKEN=${CF_API_TOKEN}

    volumes:
      # Docker socket (read-only for security)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Let's Encrypt certificates
      - traefik-certs:/letsencrypt
      # Dynamic configuration
      - ./docker/traefik/dynamic:/etc/traefik/dynamic:ro

    networks:
      - mineclifford-network

    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"

      # Dashboard routing
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN_NAME}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=cloudflare"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"

      # Dashboard authentication (same as platform)
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_USER}:${TRAEFIK_DASHBOARD_PASSWORD_HASH}"

  # Backend FastAPI
  web-backend:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    container_name: mineclifford-backend
    restart: unless-stopped
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount terraform and ansible directories for cloud deployments
      - ./terraform:/app/terraform:ro
      - ./deployment:/app/deployment:ro
      - ./ssh_keys:/app/ssh_keys:ro
      - ./static_ip.ini:/app/static_ip.ini:ro
    environment:
      - DATABASE_URL=sqlite:///app/data/mineclifford.db
      - LOG_LEVEL=INFO
      - REDIS_URL=redis://redis:6379
      - TZ=${TZ:-UTC}
    depends_on:
      - redis
    networks:
      - mineclifford-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"

      # API routing
      - "traefik.http.routers.api.rule=Host(`api.${DOMAIN_NAME}`) || Host(`${DOMAIN_NAME}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=cloudflare"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.services.api.loadbalancer.server.port=8000"

      # BasicAuth for alpha testing (REMOVE when implementing proper user auth)
      - "traefik.http.routers.api.middlewares=alpha-auth,security-headers"
      - "traefik.http.middlewares.alpha-auth.basicauth.users=${TRAEFIK_DASHBOARD_USER}:${TRAEFIK_DASHBOARD_PASSWORD_HASH}"

      # Security headers
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"

  # Frontend Nginx
  web-frontend:
    image: nginx:alpine
    container_name: mineclifford-frontend
    restart: unless-stopped
    volumes:
      - ./src/web/frontend:/usr/share/nginx/html:ro
      - ./docker/web/nginx-traefik.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web-backend
    networks:
      - mineclifford-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"

      # Frontend routing
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=cloudflare"
      - "traefik.http.routers.frontend.service=frontend"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"

      # BasicAuth for alpha testing (REMOVE when implementing proper user auth)
      - "traefik.http.routers.frontend.middlewares=alpha-auth,security-headers"

  # Redis cache
  redis:
    image: redis:7-alpine
    container_name: mineclifford-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - mineclifford-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mineclifford-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
  traefik-certs:
    driver: local
